---
import { Image } from 'astro:assets';
import { getImage } from 'astro:assets';

/*
INFORMATIONS
set: 
- image as imagemetadata
- alt as string
- width and/or height as numbers
set optionally:
- class as string
- duration as string 'value and s | ms' 
- format as string
- positionY as string (y value, default center)
*/

interface Props {
  class?: string;
  duration?: string;
  imagePath: string;
  alt: string;
  width?: number;
  height?: number;
  format?: string;
  loading?: string;
  positionY?: string;
}
// prettier-ignore
const { class:classList, duration='.5s', imagePath, alt, width, height, format = 'webp',loading='lazy', positionY='center', ...attrs } = Astro.props;

const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/**/*.{jpg,jpeg,png,webp,avif,svg,gif,eps,raw,bmp,tiff,ico}'
);
if (!images[imagePath]) throw new Error(`${imagePath} does not exist`);
// prettier-ignore
const optImg = await getImage({ src: images[imagePath](), width, height, format, loading,
});
const styles = `--url: url(${optImg.src});--duration: ${duration};--positionY: ${positionY};`;
---

<!-- prettier-ignore -->
<figure class={classList} {...attrs} style={styles}>
  <Image  src={images[imagePath]()} alt={alt} width={1} height={1} format={format} loading="lazy"
  />
  <div class="bg-image"></div>
  <div class="bg-image"></div>
  <figcaption><slot /></figcaption>
</figure>

<style>
  figure {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: clip;

    img {
      display: block;
      position: relative;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .bg-image {
      position: absolute;
      top: 0;
      transition: var(--duration);
      background-image: var(--url);
      background-size: cover;
      background-repeat: no-repeat;
      background-position-y: var(--positionY);
      width: 50%;
      height: 100%;

      &:nth-of-type(1) {
        left: 0;
        transform-origin: bottom;
        z-index: 1;
        background-position-x: left;
      }
      &:nth-of-type(2) {
        right: 0;
        transform-origin: top;
        z-index: 1;
        background-position-x: right;
      }
    }
    figcaption {
      display: flex;
      position: absolute;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1em;
      inset: 0;
      background: #000;
      color: #fff;
      text-align: center;
      a {
        color: inherit;
      }
    }

    &:hover {
      .bg-image {
        &:nth-of-type(1) {
          transform: rotateX(90deg) translateY(50%);
        }
        &:nth-of-type(2) {
          transform: rotateX(90deg) translateY(-50%);
        }
      }
      a {
        z-index: 1;
      }
    }
  }
</style>
